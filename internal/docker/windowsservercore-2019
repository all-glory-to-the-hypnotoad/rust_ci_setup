# syntax=docker/dockerfile:1

# Select base image
FROM cirrusci/windowsservercore:visualstudio2022-2022.06.23

ENV RUSTUP_HOME=C:\rustup \
    CARGO_HOME=C:\cargo

SHELL ["powershell.exe", "-NoLogo", "-NoProfile", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]
# SHELL ["powershell.exe", "-NoLogo", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

#RUN choco install -y llvm; \
#    choco install -y rust; \
#    Remove-Item C:\ProgramData\chocolatey\logs\* -Force -Recurse ; \
#    Remove-Item $Env:localappdata\Nuget\Cache\*nupkg ; \
#    Remove-Item $Env:temp\* -Force -Recurse

# RUN Invoke-WebRequest -Uri https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe -OutFile C:\rustup-init.exe;
# RUN Start-Process -Wait -FilePath C:\rustup-init.exe -ArgumentList 'install --default-toolchain stable -y';
# RUN Remove-Item C:\rustup-init.exe;
# RUN ls
# RUN ls ${en:CARGO_HOME}
# RUN rustup --version;
# RUN cargo --version;

RUN [Net.ServicePointManager]::SecurityProtocol = [Net.ServicePointManager]::SecurityProtocol -bor [Net.SecurityProtocolType]::Tls12; \
    $url = 'https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe'; \
    Invoke-WebRequest -Uri $url -OutFile C:\rustup-init.exe; \
    New-Item ${env:CARGO_HOME}\bin -type directory | Out-Null; \
    $newPath = ('{0}\bin;{1}' -f ${env:CARGO_HOME}, ${env:PATH}); \
    [Environment]::SetEnvironmentVariable('PATH', $newPath, [EnvironmentVariableTarget]::Machine); \
    [Environment]::SetEnvironmentVariable('PATH', $newPath, [EnvironmentVariableTarget]::Process); \
    C:\rustup-init.exe -y -v --no-modify-path --default-toolchain stable --default-host x86_64-pc-windows-msvc; \
    Remove-Item C:\rustup-init.exe; \
    rustup -V; \
    cargo -V; \
    rustc -V
